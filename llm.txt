# @marianmeres/pubsub

> Lightweight pub/sub event system for TypeScript/JavaScript

## Package Metadata

name: @marianmeres/pubsub
version: 2.4.1
type: Lightweight publish-subscribe event system
runtime: Deno-first, dual distribution (Deno + NPM)
language: TypeScript
license: MIT
repository: https://github.com/marianmeres/pubsub
author: Marian Meres
dependencies: None (zero runtime dependencies)

## Description

A minimal, zero-dependency publish-subscribe (pub/sub) event system implemented in TypeScript. Provides topic-based event dispatching with wildcard subscription support, error isolation, and automatic memory cleanup. Designed for Deno with NPM distribution support.

## Installation

Deno:
  import { createPubSub } from "jsr:@marianmeres/pubsub";

NPM:
  npm install @marianmeres/pubsub
  import { createPubSub } from "@marianmeres/pubsub";

## Project Structure

/
├── src/
│   ├── mod.ts              # Barrel export (re-exports pubsub.ts)
│   └── pubsub.ts           # Core implementation (~144 lines)
├── tests/
│   └── pubsub.test.ts      # Test suite (13 tests)
├── scripts/
│   └── build-npm.ts        # NPM build/transpile script
├── .npm-dist/              # Generated NPM package (gitignored)
├── deno.json               # Deno config, tasks, version
├── deno.lock               # Dependency lock
├── README.md               # User documentation
└── LICENSE                 # MIT license

## API Reference

### Types

Subscriber = (detail: any) => void
  - Callback function invoked when an event is published

Unsubscriber = () => void | boolean
  - Function returned by subscribe methods to remove the subscription

ErrorHandler = (error: Error, topic: string, isWildcard: boolean) => void
  - Custom error handler for subscriber errors

PubSubOptions = { onError?: ErrorHandler }
  - Configuration options for PubSub instance

### Class: PubSub

constructor(options?: PubSubOptions)
  - Creates new PubSub instance
  - options.onError: Custom error handler (defaults to console.error)

publish(topic: string, data?: any): boolean
  - Publishes data to all subscribers of the given topic
  - Also notifies wildcard ("*") subscribers with envelope { event, data }
  - Returns true if topic has subscribers

subscribe(topic: string, cb: Subscriber): Unsubscriber
  - Subscribes callback to topic
  - Returns unsubscriber function

subscribeOnce(topic: string, cb: Subscriber): Unsubscriber
  - Subscribes callback that auto-unsubscribes after first invocation
  - Unsubscribes even if callback throws an error

unsubscribe(topic: string, cb?: Subscriber): boolean
  - Removes specific callback from topic, or all callbacks if cb omitted
  - Returns true if removal was successful

unsubscribeAll(topic?: string): boolean
  - Removes all subscriptions from specific topic, or all topics if omitted
  - Returns true on success

isSubscribed(topic: string, cb: Subscriber, considerWildcard?: boolean): boolean
  - Checks if callback is subscribed to topic
  - considerWildcard (default: true): also check wildcard subscriptions

__dump(): Record<string, Set<Subscriber>>
  - Debug method returning internal subscription map

### Factory Function

createPubSub(options?: PubSubOptions): PubSub
  - Convenience factory function for creating PubSub instances

## Usage Examples

Basic pub/sub:
  const ps = createPubSub();
  const unsub = ps.subscribe("topic", (data) => console.log(data));
  ps.publish("topic", { message: "hello" });
  unsub();

Subscribe once:
  ps.subscribeOnce("topic", (data) => console.log("only once:", data));

Wildcard subscription:
  ps.subscribe("*", ({ event, data }) => console.log(`${event}:`, data));

Custom error handling:
  const ps = createPubSub({
    onError: (error, topic, isWildcard) => {
      myLogger.error(`Error in ${topic}:`, error);
    }
  });

Silent mode (suppress errors):
  const ps = createPubSub({ onError: () => {} });

Unsubscribe patterns:
  unsub();                           // via returned function
  ps.unsubscribe("topic", callback); // specific callback
  ps.unsubscribe("topic");           // all from topic
  ps.unsubscribeAll();               // everything
  ps.unsubscribeAll("topic");        // all from specific topic

Check subscription:
  ps.isSubscribed("topic", callback);         // considers wildcard
  ps.isSubscribed("topic", callback, false);  // excludes wildcard check

## Key Features

1. Wildcard subscriptions: Subscribe to "*" to receive all events as { event, data } envelope
2. Error isolation: Each subscriber wrapped in try-catch; errors don't propagate to other subscribers
3. Memory cleanup: Empty topic sets auto-deleted after last unsubscribe
4. Synchronous execution: Subscribers called in subscription order
5. Zero dependencies: Pure TypeScript, no runtime dependencies
6. subscribeOnce: Guarantees unsubscribe even if callback throws (uses try-finally)

## Implementation Details

Internal storage: Map<string, Set<Subscriber>>
  - Topics as keys, Sets of subscriber callbacks as values
  - Empty Sets cleaned up automatically on unsubscribe

Wildcard behavior:
  - Publishing to "*" only triggers wildcard subscribers
  - Regular topic publishes trigger both topic AND wildcard subscribers
  - Wildcard subscribers receive envelope: { event: topicName, data: publishedData }

Error handling:
  - Default: console.error with descriptive message
  - Custom: pass onError to constructor/factory
  - Errors include: error object, topic string, isWildcard boolean

## Development

### Commands

Run tests (watch mode):
  deno test --watch
  deno task test

Build NPM package:
  deno task npm:build

Build and publish to NPM:
  deno task npm:publish

### Development Dependencies (Deno)

@std/assert@1 - Testing assertions
@std/fs@^1.0.17 - File operations (build script)
@std/path@^1.0.9 - Path utilities (build script)

### Code Style

Tabs for indentation
90 character line width
4-space indent width (for tab rendering)
no-explicit-any lint rule disabled

### Test Coverage (13 tests)

1. Basic pub/sub lifecycle
2. subscribeOnce auto-unsubscribe
3. Early unsubscribe before trigger
4. Publishing undefined data
5. Manual unsubscribe(topic, cb)
6. unsubscribe(topic) clears all for topic
7. unsubscribeAll() clears everything
8. Wildcard "*" subscriptions with envelope
9. isSubscribed with/without wildcard consideration
10. Error isolation (throwing subscriber doesn't break others)
11. Wildcard error isolation
12. subscribeOnce error handling (still unsubscribes)
13. Custom error handler

### NPM Build Process

1. Create/empty .npm-dist/
2. Copy src/ to .npm-dist/src/
3. Rewrite .ts imports to .js (regex replacement)
4. Generate tsconfig.json (ESNext target, declarations)
5. Run tsc -p tsconfig.json
6. Generate package.json from deno.json metadata
7. Cleanup temp files

Output: ES module package with TypeScript declarations

## Workflows

### Adding a new feature

1. Implement in src/pubsub.ts
2. Export types in src/pubsub.ts if needed
3. Add tests in tests/pubsub.test.ts
4. Update README.md if public API changes
5. Bump version in deno.json
6. Run deno task npm:build to verify NPM build

### Publishing

1. Ensure tests pass: deno test
2. Update version in deno.json
3. Commit and tag: git tag v{version}
4. Push: git push && git push --tags
5. Publish: deno task npm:publish
